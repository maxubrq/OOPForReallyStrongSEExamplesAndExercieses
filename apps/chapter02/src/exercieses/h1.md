# Speakeasy Bar — Pricing & Promotions Specification (Problem Statement)

## 0) Objectives

Design a pricing engine that:

* Produces correct totals in **minor units** (VND đồng / USD cents).
* Applies **stackable** promotions with clear **precedence**, **caps**, and **eligibility**.
* Is auditable (transparent breakdowns) and extensible (new rules without code changes).

---

## 1) Core Domain

### 1.1 Menu

* **BaseCocktail**: `OldFashioned | Negroni | Martini | Margarita | WhiskeySour | Daiquiri | Highball | Mocktail`
* **PourSize**: `Single (45ml)` | `Double (+30ml)` — priced by multiplier (bps).
* **Modifiers** (per-line add-ons):
  `PremiumSpiritUpgrade | SmokedGlass | LargeClearIce | EggWhite | HouseSyrupFlavor | SpiceRim`

### 1.2 Money & Currency

* All values in **minor units**. No floats.
* Percentages expressed in **basis points** (bps). `1000 bps = 10%`.

### 1.3 Taxes/Charges (jurisdiction-configurable)

* Examples: `VAT 10%` (VN), `Service 5%` (venue policy), local SalesTax (US).
* Applied **order-level** after discounts unless law requires different sequence.

---

## 2) Promotions & Discounts (Composite)

### 2.1 Happy Hour (time-window)

* Configurable windows (e.g., `17:00–19:00`, `22:00–23:00`), optional **days-of-week** filter.
* Discount e.g., **10% off** eligible items (**item-level** rule).

### 2.2 Ladies’ Night (eligibility-based)

* **Lady Night**: e.g., Thursdays 20:00–23:00.
* Benefit options (configurable, pick any combination):

  * `Buy 1 Get 1` (BOGO) on select cocktails.
  * Flat **amount off** per eligible line (e.g., 30,000 VND off).
  * **% off** category (e.g., 15% off “Sours”).
* **Eligibility**: customer flag on the tab (verified at entry); may require **ID scan** or **guest list tag**.
* **Cap** (per-guest or per-check): e.g., max **2 free items** or **150,000 VND** total benefit.

### 2.3 Membership Discount (tiered)

* Tiers: `Bronze | Silver | Gold | Black`.
* Benefits (stackable, per-tier config):

  * `% off` menu price (item-level or order-level).
  * **Waived cover** or **reduced service fee**.
  * **Points accrual** (not part of price but returned for ledger).
* **Floor price**: membership discounts may not drop line below **cost + margin floor**.

### 2.4 Composite Discount Engine

* Multiple promotions can apply. Define **stacking rules** and **precedence**:

  1. **Item-level** percentage discounts (e.g., Happy Hour)
  2. **Item-level** amount discounts (e.g., Ladies’ Night line rebate)
  3. **Item-level** free-item mechanics (BOGO, bundles)
  4. **Order-level** percentage discounts (e.g., Membership order % off)
  5. **Order-level** amount discounts (e.g., coupon 100,000 VND off)
  6. **Surcharges** (e.g., late-night 5%, service 5%)
  7. **Taxes** (VAT / SalesTax)

* **Caps & Limits**

  * **Per-line cap** (cannot reduce below floor).
  * **Per-promo cap** (e.g., ≤ 200,000 VND total discount).
  * **Per-check cap** (global max discount).

* **Exclusivity**

  * Some promos **mutually exclusive** (e.g., BOGO vs 50% off the same SKU).
  * Some promos **require** others (e.g., “Members + Ladies’ Night” combo).

* **Blackout dates** / calendar events override standard rules.

### 2.5 Other Realistic Promotions (optional to implement)

* **Bundle pricing**: “Any 2 Classic Cocktails for 300,000 VND”.
* **Set menu**: “Date Night Set” includes 2 cocktails + clear ice upgrade for a fixed price.
* **Minimum spend incentive**: Spend ≥ 1,000,000 VND → 10% off desserts/mocktails.
* **Table service tier**: High table min-spend; service charge waived if min met.

---

## 3) Operational Constraints

### 3.1 Compliance & Safety

* **ABV guardrails**: per-guest max alcoholic units/time window.
* **Age/ID**: no discounts that encourage underage drinking.

### 3.2 Inventory-aware Pricing (optional)

* **Dynamic surcharge** if premium spirits low-stock (e.g., +10,000 VND).
* **Auto-disable** promos if component out-of-stock.

### 3.3 Cover Charges & Seating

* **Cover**: e.g., 100,000 VND after 21:00 Fri/Sat; can be:

  * always charged, or
  * waived by Membership tier, or
  * converted to drink credit (one-time per guest).
* **Table minimum**: enforce min spend by seat type and time slot.

---

## 4) Calculation Requirements (Deterministic, Auditable)

1. **Line base** = `MenuPrice(Single) × PourMultiplier(bps)`
2. **+ Modifiers** (sum of fixed surcharges)
3. **Apply item-level % discounts** (bps; round half-up)
4. **Apply item-level amount discounts** (respect floor)
5. **Apply free-item mechanics** (BOGO/bundles → generate zero-priced shadow lines or negative adjustments)
6. **Compute Subtotal (items)**
7. **Apply order-level % discounts**
8. **Apply order-level amount discounts**
9. **Apply surcharges** (late-night, service, table)
10. **Apply taxes** (after discounts; service may be before/after tax per jurisdiction)
11. **Grand total** in minor units
12. **Return full breakdown**: each rule’s input, output, and rounding

**Rounding policy**: integer math; percentage operations round **half up** at each step; never produce negative prices.

---

## 5) Rule Configuration Model (high-level)

* **Catalog**

  * `baseByDrink[Drink] = minor`
  * `pourMultiplierBps[PourSize]`
  * `modifierFees[Modifier] = minor`

* **Promotions\[]**

  * `id, name, active`
  * `scope: 'item' | 'order'`
  * `mechanic: 'PCT_OFF' | 'AMOUNT_OFF' | 'BOGO' | 'BUNDLE' | 'SET_PRICE'`
  * `value: bps | minor | structured (for BOGO/bundle)`
  * `eligibility`: `{daysOfWeek?, timeRanges?, membershipTiers?, guestTags?, menuFilters?, minSpend?, seatType?, calendarEventIds?, blackoutDates?}`
  * `caps`: `{perLine?, perPromo?, perCheck?}` (minor)
  * `exclusivityGroup?: string`
  * `precedence: integer` (lower runs first)

* **Surcharges\[]** (late-night, service)

  * `scope: 'order'`, `mechanic: 'PCT' | 'AMOUNT'`, `eligibility`, `precedence`

* **Taxes\[]**

  * `label`, `bps`, `applyOn: 'postDiscountPreService' | 'postDiscountPostService'` (jurisdictional)

* **Floors**

  * `costFloorBySKU?` or `marginFloorBps?`

---

## 6) Acceptance Criteria (must pass)

1. **Minor-only math**: no floats anywhere.
2. **Deterministic order of operations** via `precedence`.
3. **Stacking** respects caps, floors, and exclusivity.
4. **Auditable**: engine returns per-rule deltas and intermediate totals.
5. **Time & eligibility**: correct application by clock, day, membership, guest tags.
6. **Calendar**: blackout dates disable conflicting promos.
7. **Idempotent**: recalculating the same input yields the same output.
8. **Safety**: never price < 0; enforce floor.

---

## 7) Test Scenarios (black-box)

> Use these as problem inputs/outputs (values illustrative).

### T1 — Happy Hour + Modifiers

* Tue 17:30, Guest: none, Item: `Negroni`, `Double`, Modifiers: `LargeClearIce`.
* Promos: `HappyHour 10% item-level`.
* Expect: Base×multiplier + modifier, then −10% (rounded), no taxes if disabled.

### T2 — Ladies’ Night BOGO with Cap

* Thu 21:00, Guest tag: `LadyNightEligible`.
* Order: 2× `Martini`, both `Single`.
* Promo: `LadiesNight BOGO same-SKU`, cap **1 free item per guest**.
* Expect: 1 paid, 1 free (or explicit negative adj), cap respected.

### T3 — Membership + Order Coupon + Floor

* Fri 20:00, Membership `Gold` (5% order-level), Coupon `AMOUNT_OFF 80,000 VND` order-level.
* One `OldFashioned` with `PremiumSpiritUpgrade`.
* Floor: cannot drop line below `cost + 20% margin`.
* Expect: item computed, then membership % (respecting floor), then coupon amount capped by floor.

### T4 — Composite: Happy Hour + Ladies’ Night + Membership

* Thu 20:30, Membership `Silver (3%)`, Guest `LadyNightEligible`.
* Items: `WhiskeySour` (EggWhite), `Negroni` (no mods).
* Promos precedence: item% (HH) → item amount (LN flat 20,000 off) → order% (Membership) → taxes.
* Expect: proper stacking and rounding per step, with full breakdown.

### T5 — Blackout Date

* Special Event (NYE): **All promos off**; `Cover 150,000 VND` applies.
* Expect: no discounts, cover added before tax (if configured).

### T6 — Surcharge + Tax Sequencing (VN)

* Sat 23:30, Late-night surcharge 5% (order-level), Service 5%, VAT 10% **after service**.
* Expect: subtotal → surcharge → service → VAT.

### T7 — Per-Check Cap

* Multiple items; total discounts would exceed **200,000 VND** cap.
* Expect: engine trims the last applied discount to hit the cap exactly.

### T8 — Inventory Surcharge

* Premium gin low-stock triggers +10,000 VND on any `PremiumSpiritUpgrade`.
* Expect: modifier fee increased, then discounts applied.

---

## 8) Output Format (breakdown contract)

Return:

* `lines[]`: for each item → `base`, `mods[]`, `discounts[]`, `adjustedLineTotal`
* `orderDiscounts[]`, `surcharges[]`, `taxes[]`
* `capsApplied[]` (which cap trimmed what, by how much)
* `grandTotal` (minor units)
* `roundingNotes[]` (where rounding occurred)

---

## 9) Non-Goals / Out of Scope (for now)

* Payments, tips, refunds.
* Multi-currency in the same check.
* Real-time stock deduction (only pricing-time signals).